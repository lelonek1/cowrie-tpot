########################################################
# T-Pot                                                #
# Cowrie upstart script                                #
#                                                      #
# v16.03.4 by av / mo, DTAG, 2016-03-03                #
########################################################

description "Cowrie-telnet"
author "av"
start on started docker and filesystem
stop on runlevel [!2345]
respawn
pre-start script
  # Remove any existing cowrie containers
  myCID=$(docker ps -a | grep cowrie-telnet | awk '{ print $1 }')
  if [ "$myCID" != "" ];
    then docker rm -v $myCID;
  fi
  # Remove any data from previous container if persistence is not enabled 
  if ! [ -f /data/persistence.on ];
    then
      rm -rf /data/cowrie-telnet/* || true
      mkdir -p /data/cowrie-telnet/log/tty/ /data/cowrie-telnet/downloads/ /data/cowrie-telnet/keys/ /data/cowrie-telnet/misc/
      chmod 760 /data/cowrie-telnet -R
      chown tpot:tpot /data/cowrie-telnet -R
  fi
end script
script
  /usr/bin/docker run --name cowrie-telnet --rm=true -p 23:2223 -v /data/cowrie-telnet:/data/cowrie lelonek1/cowrie-tpot:latest1610
end script
post-start script
  # Delay next start to avoid rapid respawning
  sleep 2
end script
